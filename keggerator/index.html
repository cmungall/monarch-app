<!DOCTYPE html>
<html>
<head>
    <title>Keggerator</title>
</head>
<body>
<script type="application/javascript" src="js/d3.min.js"></script>
<script type="application/javascript" src="js/colorbrewer.v1.min.js"></script>
<script type="application/javascript" src="js/jquery-1.10.2.min.js"></script>
<script type="application/javascript" src="js/raphael-min-2.1.0.js"></script>
<script type="application/javascript" src="js/jquery.xml2json.js"></script>
<script type="application/javascript" src="js/jquery.xml2json.js"></script>

<style>

    #twoColumnContainer {
        width:100%;
    }
    #keggImageColumn {
        float:left;
        padding: 0;
        outline: 1px solid #999;
    }
    #kgmlSelectColumn {
        float:right;
    }


</style>

<script>
    // the kgml file is loaded when user enters a kegg id
    var kgmlJson = {};
    var canvasXOffset = 22;
    var canvasYOffset = 8;
    var paper;
    var raphaelElements = [];


    $(function() {


        $("#keggIdButton").on("click", function() {

            // update kgml image
            keggId = $("#keggId").val();
            $("#keggImage").attr("src","http://rest.kegg.jp/get/" + keggId + "/image");
            paper = Raphael(document.getElementById("canvas"), 1024, 768);

            // retrieve kgml for this id
            $.get("http://rest.kegg.jp/get/" + keggId + "/kgml", function(xml){
                kgmlJson = $.xml2json(xml);

                // update the kgml select options
                var $el = $("#kgmlSelect");
                $el.empty(); // remove old options
                $.each(kgmlJson.entry, function() {
                    $el.append($("<option></option>").attr("value", this.name).text(this.graphics.name));

                });
            });
        });

        // submit kgml entries for highlighting
        $("#highlightButton").on("click",function() {
            var kgmlVals = $( "#kgmlSelect" ).val() || [];
            console.log( kgmlVals.join(",") + " was selected");
            $.each(kgmlVals, function(k) {

                // extract the value
                var entry = $.grep(kgmlJson.entry, function(e){
                    return e.name === kgmlVals[k];
                });
                console.log("found " + entry[0].name + " " + entry[0].graphics.type);
                if (entry[0].graphics.type === "rectangle") {

                    raphaelElements.push(
                            paper.rect(entry[0].graphics.x - canvasXOffset, entry[0].graphics.y - canvasYOffset, entry[0].graphics.width, entry[0].graphics.height)
                                    .animate({
                                        "fill": "#f00",
                                        "fill-opacity": .5,
                                        "stroke": "#fff"
                                    }, 2000)
                                    .click(function () {
                                        alert("You clicked " + entry[0].graphics.name);
                                    })
                    );
                }
            })
        });

        $("#eraseButton").on("click",function() {
            $.each(raphaelElements, function(r) {
                raphaelElements[r].remove();
            })
        });



    $(function () {
        // tell keggerator where to draw stuff and handle ui events
        keggerator.init($("#imageDiv"), $("#selectList"));
        $("#highlightButton").on("click", keggerator.highlight);
        $("#eraseButton").on("click", keggerator.clearHighlights);

        // the pathway id
        keggerator.setPathwayId("ko05012");

        // the phenotype gene map
        $.getJSON("./js/phenotypeGeneIdMap.json")
                .done(function (data) {
                    keggerator.setPhenotypeGeneIdMap(data);
                }
        );


    });


</script>

<h1><img src="kegerator.jpg" height="80" width="80" />Keggerator - Kegg Pathway JS Annotator</h1>

<div>
    Kegg Id<input type="text" size="80" id="keggId" value="ko05012"/><input id="keggIdButton" type="button" value="Get It">
</div>

<div id="twoColumnContainer">

    <div id="keggImageColumn">
        <img id="keggImage" src=""/>
        <div id="canvas"></div>
    </div>

    <div id="kgmlSelectColumn">
        <select id="kgmlSelect" multiple="multiple" size="20">
            <option>Enter a Kegg Id First</option>
        </select><br/>
        <input id="highlightButton" type="button" value="Highlight"/><br/>
        <input id="eraseButton" type="button" value="Erase All Highlights"/><br/>
    </div>

</div>
</body>
</html>